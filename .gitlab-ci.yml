image: ccbuild/omnibus-debian
stages:
 - patch
 - package
 - test
 - deploy

variables:
  # ORIGIN: https://github.com/chef/chef.git
  ORIGIN: -b dist_solo_zero https://github.com/cc-build/chef.git

client_patch:
  stage: patch
  tags:
    - osuosl
  script:
    - echo "Cloning from $ORIGIN"
    - git clone --depth=1 $ORIGIN
    - cp -R cinc/* chef/
    - mkdir -p ${CI_PROJECT_DIR}/{cache,src}
    - echo "cache_dir ${CI_PROJECT_DIR}/cache" >> chef/omnibus/omnibus.rb
    - echo "source_dir ${CI_PROJECT_DIR}/src" >> chef/omnibus/omnibus.rb
  artifacts:
    expire_in: 1d
    paths:
      - chef/

client-package:deb:
  stage: package
  tags:
    - osuosl
  dependencies:
    - client_patch
  script:
    - apt-get update
    - source /home/omnibus/load-omnibus-toolchain.sh | egrep -v "(CI|FF_|GITLAB_|SSH_KNOWN_HOSTS|SSH_PRIVATE_KEY)"
    - cd chef/omnibus
    - bundle install --without development
    - bundle exec omnibus build cinc
    - mv pkg/* $CI_PROJECT_DIR
  cache:
    paths:
      - cache/*
      - src/*
  artifacts:
    expire_in: 1mo
    paths:
      - ./*.deb
      - ./*.json

client-test:deb:
  stage: test
  tags:
    - osuosl
  dependencies:
    - client-package:deb
  script:
    - dpkg -i cinc*.deb
    - /opt/cinc/bin/cinc-client --version
    - /opt/cinc/bin/cinc-solo -l info
    - cinc-client --version
    - cinc-solo -l info

client-deploy:deb:
  when: manual
  stage: deploy
  tags:
    - osuosl
  dependencies:
    - client-package:deb
    - client-test:deb
  before_script:
    - eval $(ssh-agent -s)
    - echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "${SSH_KNOWN_HOSTS}" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh cc-build@${MIRROR_HOST} "mkdir -p ~/ftp/cinc/debian/9"
    - rsync -avH *.deb *.json cc-build@${MIRROR_HOST}:~/ftp/cinc/debian/9/
    - ssh cc-build@${MIRROR_HOST} "/home/cc-build/trigger-cc-build"

client-package:rpm:
  image: ccbuild/omnibus-centos
  stage: package
  tags:
    - osuosl
  dependencies:
    - client_patch
  script:
    - source /home/omnibus/load-omnibus-toolchain.sh | egrep -v "(CI|FF_|GITLAB_|SSH_KNOWN_HOSTS|SSH_PRIVATE_KEY)"
    - cd chef/omnibus
    - bundle install --without development
    - bundle exec omnibus build cinc
    - mv pkg/* $CI_PROJECT_DIR
  cache:
    paths:
      - cache/*
      - src/*
  artifacts:
    expire_in: 1mo
    paths:
      - ./*.rpm
      - ./*.json

client-test:rpm:
  image: ccbuild/omnibus-centos
  stage: test
  tags:
    - osuosl
  dependencies:
    - client-package:rpm
  script:
    - yum -y install cinc*.rpm
    - /opt/cinc/bin/cinc-client --version
    - /opt/cinc/bin/cinc-solo -l info
    - cinc-client --version
    - cinc-solo -l info

client-deploy:rpm:
  when: manual
  image: ccbuild/omnibus-centos
  stage: deploy
  tags:
    - osuosl
  dependencies:
    - client-package:rpm
    - client-test:rpm
  before_script:
    - eval $(ssh-agent -s)
    - echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "${SSH_KNOWN_HOSTS}" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh cc-build@${MIRROR_HOST} "mkdir -p ~/ftp/cinc/el/7"
    - rsync -avH *.rpm *.json cc-build@${MIRROR_HOST}:~/ftp/cinc/el/7/
    - ssh cc-build@${MIRROR_HOST} "/home/cc-build/trigger-cc-build"
