image: ccbuild/omnibus-debian
stages:
 - patch
 - package
 - test
 - deploy

variables:
  # ORIGIN: https://github.com/chef/chef.git
  ORIGIN: -b dist_solo_zero https://github.com/cc-build/chef.git

client_patch:
  stage: patch
  tags:
    - osuosl
  script:
    - echo "Cloning from $ORIGIN"
    - git clone --depth=1 $ORIGIN
    - cp -R cinc/* chef/
    - mkdir -p ${CI_PROJECT_DIR}/{cache,cache/git_cache}
    - echo "cache_dir '${CI_PROJECT_DIR}/cache'" >> chef/omnibus/omnibus.rb
    - echo "git_cache_dir '${CI_PROJECT_DIR}/cache/git_cache'" >> chef/omnibus/omnibus.rb
    - sed -i -e 's/^use_git_caching false/use_git_caching true/g' chef/omnibus/omnibus.rb
  artifacts:
    expire_in: 1d
    paths:
      - chef/

.client-package:
  stage: package
  tags:
    - osuosl
  dependencies:
    - client_patch
  script:
    - source /home/omnibus/load-omnibus-toolchain.sh
    - cd chef/omnibus
    - bundle install --without development
    - bundle exec omnibus build cinc
    - mkdir files
    - mv pkg/* ${CI_PROJECT_DIR}/files/
  cache:
    paths:
      - cache/*
  artifacts:
    expire_in: 1mo
    paths:
      - files/*

client-package:debian-8:
  extends: .client-package
  image: ccbuild/omnibus-debian:8
  after_script:
    - mkdir -p ${CI_PROJECT_DIR}/files/debian
    - mv ${CI_PROJECT_DIR}/files ${CI_PROJECT_DIR}/files/debian/8

client-package:debian-9:
  extends: .client-package
  image: ccbuild/omnibus-debian:9
  after_script:
    - mkdir -p ${CI_PROJECT_DIR}/files/debian
    - mv ${CI_PROJECT_DIR}/files ${CI_PROJECT_DIR}/files/debian/9

client-package:ubuntu-14.04:
  extends: .client-package
  image: ccbuild/omnibus-ubuntu:14.04
  after_script:
    - mkdir -p ${CI_PROJECT_DIR}/files/ubuntu
    - mv ${CI_PROJECT_DIR}/files ${CI_PROJECT_DIR}/files/ubuntu/14.04

client-package:ubuntu-16.04:
  extends: .client-package
  image: ccbuild/omnibus-ubuntu:16.04
  after_script:
    - mkdir -p ${CI_PROJECT_DIR}/files/ubuntu
    - mv ${CI_PROJECT_DIR}/files ${CI_PROJECT_DIR}/files/ubuntu/16.04

client-package:ubuntu-18.04:
  extends: .client-package
  image: ccbuild/omnibus-ubuntu:18.04
  after_script:
    - mkdir -p ${CI_PROJECT_DIR}/files/ubuntu
    - mv ${CI_PROJECT_DIR}/files ${CI_PROJECT_DIR}/files/ubuntu/18.04

client-package:centos-6:
  extends: .client-package
  image: ccbuild/omnibus-centos:6
  after_script:
    - mkdir -p ${CI_PROJECT_DIR}/files/centos
    - mv ${CI_PROJECT_DIR}/files ${CI_PROJECT_DIR}/files/centos/6

client-package:centos-7:
  extends: .client-package
  image: ccbuild/omnibus-centos:7
  after_script:
    - mkdir -p ${CI_PROJECT_DIR}/files/centos
    - mv ${CI_PROJECT_DIR}/files ${CI_PROJECT_DIR}/files/centos/7

.client-test:
  stage: test
  tags:
    - osuosl
  script:
    - /opt/cinc/bin/cinc-client --version
    - /opt/cinc/bin/cinc-solo -l info
    - cinc-client --version
    - cinc-solo -l info

client-test:debian-8:
  extends: .client-test
  image: ccbuild/omnibus-debian:8
  dependencies:
    - client-package:debian-8
  before_script:
    - dpkg -i files/debian/8/cinc*.deb

client-test:debian-9:
  extends: .client-test
  image: ccbuild/omnibus-debian:9
  dependencies:
    - client-package:debian-9
  before_script:
    - dpkg -i files/debian/9/cinc*.deb

client-test:ubuntu-14.04:
  extends: .client-test
  image: ccbuild/omnibus-ubuntu:14.04
  dependencies:
    - client-package:ubuntu-14.04
  before_script:
    - dpkg -i files/ubuntu/14.04/cinc*.deb

client-test:ubuntu-16.04:
  extends: .client-test
  image: ccbuild/omnibus-ubuntu:16.04
  dependencies:
    - client-package:ubuntu-16.04
  before_script:
    - dpkg -i files/ubuntu/16.04/cinc*.deb

client-test:ubuntu-18.04:
  extends: .client-test
  image: ccbuild/omnibus-ubuntu:18.04
  dependencies:
    - client-package:ubuntu-18.04
  before_script:
    - dpkg -i files/ubuntu/18.04/cinc*.deb

client-test:centos-6:
  extends: .client-test
  image: ccbuild/omnibus-centos:6
  dependencies:
    - client-package:centos-6
  before_script:
    - yum -y install files/centos/6/cinc*.rpm

client-test:centos-7:
  extends: .client-test
  image: ccbuild/omnibus-centos:7
  dependencies:
    - client-package:centos-7
  before_script:
    - yum -y install files/centos/6/cinc*.rpm

client-deploy:
  when: manual
  stage: deploy
  tags:
    - osuosl
  dependencies:
    - client-test:debian-8
    - client-test:debian-9
    - client-test:ubuntu-14.04
    - client-test:ubuntu-16.04
    - client-test:ubuntu-18.04
    - client-test:centos-6
    - client-test:centos-7
  before_script:
    - eval $(ssh-agent -s)
    - echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "${SSH_KNOWN_HOSTS}" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ssh cc-build@${MIRROR_HOST} "mkdir -p /data/incoming/files/"
    - rsync -avH files/ cc-build@${MIRROR_HOST}:/data/incoming/files/
